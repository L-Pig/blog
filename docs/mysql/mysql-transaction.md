# MySQL 事务

## 一、事务四大特性(ACID)

1. **原子性（Atomicity）** ： 事务开始后所有操作，要么全部成功，要么全部失败，不可能停滞在中间环节。事务执行过程中出错，会回滚到事务开始前的状态，所有的操作就像没有发生一样。也就是说事务是一个不可分割的整体，就像化学中学过的原子，是物质构成的基本单位。
2. **一致性（Consistency）** ：一致性是指事务必须使数据库从一个一致性状态变换到另一个一致性状态，也就是说一个事务执行之前和执行之后都必须处于一致性状态。拿转账来说，假设用户A和用户B两者的钱加起来一共是5000，那么不管A和B之间如何转账，转几次账，事务结束后两个用户的钱相加起来应该还得是5000，这就是事务的一致性。
3. **隔离性（Isolation）** :隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离。
4. **持久性（Durability）** :持久性是指一个事务一旦被提交了，那么对数据库中的数据的改变就是永久性的，即便是在数据库系统遇到故障的情况下也不会丢失提交事务的操作。

## 二、事务并发问题

1. **脏读** ： 在一个事务处理过程里读取了另一个未提交的事务中的数据。
2. **不可重复读** : 是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。这样就发生了在一个事务内两次读到的数据是不一样的，因此称为是不可重复读。
3. **幻读** : 第一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行。同时，第二个事务也修改这个表中的数据，这种修改是向表中插入或删除一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象发生了幻觉一样。

## 三、事务的四种隔离级别

|         事务隔离级别         | 脏读 | 不可重复读 | 幻读 |
| :--------------------------: | :--: | :--------: | :--: |
| 读未提交（read-uncommitted） |  是  |     是     |  是  |
| 读已提交 （read-committed） |  否  |     是     |  是  |
| 可重复读（repeatable-read） |  否  |     否     |  是  |
|    串行化（serializable）    |  否  |     否     |  否  |

> **MySQL** 默认的是  **可重复读（repeatable-read）** ，而其它的数据库默认的是  **读已提交 （read-committed）**

## 四、事务的七大传播机制

|           类型           |                                                    说明                                                    |
| :-----------------------: | :--------------------------------------------------------------------------------------------------------: |
|   PROPAGATION_REQUIRED   |       如果当前没有事务，就新建一个事务，如果已经存在一个事务中，加入到这个事务中。这是最常见的选择。       |
|   PROPAGATION_SUPPORTS   |                            支持当前事务，如果当前没有事务，就以非事务方式执行。                            |
|   PROPAGATION_MANDATORY   |                               使用当前的事务，如果当前没有事务，就抛出异常。                               |
| PROPAGATION_REQUIRES_NEW |                                新建事务，如果当前存在事务，把当前事务挂起。                                |
| PROPAGATION_NOT_SUPPORTED |                         以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。                         |
|     PROPAGATION_NEVER     |                              以非事务方式执行，如果当前存在事务，则抛出异常。                              |
|    PROPAGATION_NESTED    | 如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行与**PROPAGATION_REQUIRED**类似的操作。 |

> **MySQL** 默认的是 **PROPAGATION_REQUIRED**
